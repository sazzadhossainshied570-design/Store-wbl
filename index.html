<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WATER BIRDS LIMITED | ERP PRO</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --bg-color: #020617;
            --card-bg: rgba(30, 41, 59, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #818cf8;
            --primary-glow: rgba(129, 140, 248, 0.4);
            --success: #34d399;
            --danger: #fb7185;
            --warning: #fbbf24;
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-color); 
            background-image: radial-gradient(circle at 10% 20%, rgba(129, 140, 248, 0.1) 0%, transparent 40%);
            color: var(--text-main); height: 100vh; display: flex; overflow: hidden; 
        }
        .sidebar { width: 280px; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(25px); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 40px 25px; }
        .logo-box { padding: 25px; border-radius: 24px; background: linear-gradient(145deg, rgba(255,255,255,0.05), transparent); border: 1px solid var(--glass-border); text-align: center; }
        .logo-text { font-size: 18px; font-weight: 800; letter-spacing: 2px; color: #fff; line-height: 1.4; }
        
        .sidebar-menu { flex: 1; padding: 15px; }
        .nav-item { padding: 16px 20px; border-radius: 16px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.3s; color: var(--text-dim); font-weight: 600; margin-bottom: 8px; position: relative; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 10px 25px var(--primary-glow); }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 90px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; border-bottom: 1px solid var(--glass-border); }
        .content-area { padding: 40px; overflow-y: auto; flex: 1; }
        .card { background: var(--card-bg); border-radius: 28px; padding: 30px; border: 1px solid var(--glass-border); margin-bottom: 30px; backdrop-filter: blur(15px); animation: fadeIn 0.5s ease-out; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 35px; }
        .stat-card { background: rgba(255,255,255,0.02); padding: 25px; border-radius: 28px; border: 1px solid var(--glass-border); }
        .stat-card h2 { font-size: 32px; font-weight: 800; color: var(--primary); }
        
        .btn { border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 700; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: #020617; }
        .btn-danger { background: var(--danger); color: white; }
        
        .log-filter-btns { display: flex; gap: 5px; margin-bottom: 15px; }
        .btn-filter { padding: 6px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: transparent; color: var(--text-dim); cursor: pointer; font-size: 11px; font-weight: 600; }
        .btn-filter.active { background: var(--primary); color: white; border-color: var(--primary); }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { text-align: left; padding: 12px 20px; color: var(--text-dim); font-size: 11px; text-transform: uppercase; }
        td { padding: 16px 20px; background: rgba(255,255,255,0.03); color: var(--text-main); font-size: 13px; }
        td:first-child { border-radius: 14px 0 0 14px; }
        td:last-child { border-radius: 0 14px 14px 0; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--glass-border); border-radius: 14px; background: rgba(0,0,0,0.3); color: white; outline: none; }
        .search-box { width: 200px; padding: 8px 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 10px; color: white; font-size: 12px; }

        .tab-page { display: none; }
        .tab-page.active { display: block; }
        .challan-badge { background: rgba(129, 140, 248, 0.2); color: var(--primary); padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 700; }
        .pending-badge { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; position: absolute; right: 10px; top: 18px; }
        .btn-mini { padding: 6px 10px; font-size: 12px; border-radius: 8px; border: none; cursor: pointer; }
    </style>
</head>

<body>
<div class="sidebar">
    <div class="sidebar-header">
        <div class="logo-box"><div class="logo-text">WATER BIRDS<br><span style="color:var(--primary)">LIMITED</span></div></div>
    </div>
    <div class="sidebar-menu">
        <div class="nav-item active" onclick="showTab('dashboard')"><i class="fas fa-th-large"></i> Dashboard</div>
        <div class="nav-item" onclick="showTab('entry')"><i class="fas fa-edit"></i> Stock Entry</div>
        <div class="nav-item" onclick="showTab('inventory')"><i class="fas fa-boxes"></i> Inventory</div>
        <div class="nav-item" onclick="showTab('logs')"><i class="fas fa-history"></i> Stock Logs</div>
        <div class="nav-item" id="nav-pending" style="display:none;" onclick="showTab('pending')"><i class="fas fa-clock"></i> Pending <span id="pending-count-badge" class="pending-badge">0</span></div>
        <div class="nav-item" id="nav-settings" onclick="showTab('settings')"><i class="fas fa-cog"></i> Settings</div>
    </div>
    <div style="padding: 20px;"><button id="logout-btn" class="btn btn-danger" style="width:100%; display:none;" onclick="logoutProfile()">Logout</button></div>
</div>

<div class="main">
    <div class="top-bar">
        <div id="display-name" style="font-weight:700;">Guest Mode</div>
        <div style="color: var(--success); font-weight: 700; font-size: 12px;"><i class="fas fa-circle"></i> SERVER ONLINE</div>
    </div>

    <div class="content-area">
        <div id="dashboard" class="tab-page active">
            <div class="stats-grid">
                <div class="stat-card"><p>Total Items</p><h2 id="stat-total-items">0</h2></div>
                <div class="stat-card"><p>Total In</p><h2 id="stat-total-in">0</h2></div>
                <div class="stat-card"><p>Total Out</p><h2 id="stat-total-out">0</h2></div>
            </div>
            <div id="login-section" class="card" style="max-width: 400px; margin: 0 auto; text-align: center;">
                <h3>System Login</h3>
                <select id="userSelect">
                    <option value="">Select User</option>
                    <option value="Sazzad Hossain">Sazzad Hossain</option>
                    <option value="Rokibul Islam">Rokibul Islam</option>
                    <option value="Mobin Bin Mihad">Mobin Bin Mihad</option>
                    <option value="Md.alamin">Md.alamin</option>
                    <option value="Md.shipon">Md.shipon</option>
                </select>
                <input type="password" id="userPin" placeholder="Enter PIN">
                <button class="btn btn-primary" style="width: 100%;" onclick="loginProfile()">Login</button>
            </div>
            <div id="admin-controls" class="card" style="display:none; border: 1px dashed var(--danger);">
                <button class="btn btn-danger" onclick="resetAllData()">Reset Database</button>
            </div>
        </div>

        <div id="entry" class="tab-page">
            <div id="entry-container" style="display:none; grid-template-columns: 1fr; gap:25px;">
                <div class="card">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3>Select Item</h3>
                            <select id="entryCategory" onchange="toggleEntrySelect()">
                                <option value="VESSEL">Vessel</option>
                                <option value="ACC">Accessories</option>
                            </select>
                            <select id="vesselList">
                                <option value="10×35 pressure vessel">10×35 pressure vessel</option>
                                <option value="12×52 pressure vessel">12×52 pressure vessel</option>
                                <option value="16×65 pressure vessel">16×65 pressure vessel</option>
                            </select>
                            <select id="accList" style="display:none;">
                                <option value="Ethanol">Ethanol</option>
                                <option value="Cartoon tep">Cartoon tep</option>
                                <option value="Hand Globs">Hand Globs</option>
                                <option value="Ruller brush 9 inch">Ruller brush 9"</option>
                                <option value="Paint brush 2 inch">Paint brush 2"</option>
                                <option value="Ruller Hendel">Ruller Hendel</option>
                                <option value="Fom disk">Fom disk</option>
                                <option value="Eaticing disk">Eaticing disk</option>
                                <option value="Mask">Mask</option>
                                <option value="Rapping Polly">Rapping Polly</option>
                                <option value="Revit">Revit</option>
                                <option value="Thut">Thut</option>
                                <option value="Cutting disk">Cutting disk</option>
                                <option value="Entry cutter">Entry cutter</option>
                                <option value="Fhinishing bled">Fhinishing bled</option>
                                <option value="Control Valve">Control Valve</option>
                                <option value="Strainer">Strainer</option>
                                <option value="Riser Pipe">Riser Pipe</option>
                            </select>
                            <input type="number" id="entryQty" placeholder="Quantity">
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-success" style="flex:1" onclick="directIn()">DIRECT IN</button>
                                <button class="btn btn-primary" style="flex:1" onclick="addToCart()"><i class="fas fa-plus"></i> ADD TO OUT LIST</button>
                            </div>
                        </div>
                        <div style="border-left: 1px solid var(--glass-border); padding-left: 20px;">
                            <h3>Out List (Cart)</h3>
                            <div id="cartItems" style="min-height: 100px; max-height: 250px; overflow-y: auto; margin-bottom: 15px;">
                                <p style="color: var(--text-dim); font-size: 13px; text-align: center;">No items added yet</p>
                            </div>
                            <input type="text" id="bulkChallan" placeholder="Enter Common Challan No" style="border-color: var(--primary);">
                            <button class="btn btn-danger" style="width: 100%;" onclick="submitBulkOut()">CONFIRM ALL OUT</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="entry-locked" class="card" style="text-align:center;">Login to unlock entry</div>
        </div>

        <div id="pending" class="tab-page">
            <div class="card">
                <h3>Pending Approvals</h3>
                <div style="overflow-x: auto;">
                    <table id="pendingTable">
                        <thead><tr><th>Time</th><th>User</th><th>Item</th><th>Qty</th><th>Type</th><th>Challan</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="inventory" class="tab-page">
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>Vessel Stock</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" class="search-box" id="invVesselSearch" placeholder="Search..." onkeyup="filterTable('vesselTable', 0, this.value)">
                        <button class="btn btn-primary" onclick="downloadExcel('vesselTable')">Excel</button>
                        <button class="btn btn-success" onclick="downloadPDF('vesselTable', 'Vessel Stock Report')"><i class="fas fa-file-pdf"></i> PDF</button>
                    </div>
                </div>
                <table id="vesselTable"><thead><tr><th>Item</th><th>Balance</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>Accessories Stock</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" class="search-box" id="invAccSearch" placeholder="Search..." onkeyup="filterTable('accTable', 0, this.value)">
                        <button class="btn btn-primary" onclick="downloadExcel('accTable')">Excel</button>
                        <button class="btn btn-success" onclick="downloadPDF('accTable', 'Accessories Stock Report')"><i class="fas fa-file-pdf"></i> PDF</button>
                    </div>
                </div>
                <table id="accTable"><thead><tr><th>Item</th><th>Balance</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="logs" class="tab-page">
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>Vessel History</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" class="search-box" placeholder="Search history..." onkeyup="filterLogBySearch('vesselLogTable', this.value)">
                        <button class="btn btn-success" onclick="downloadPDF('vesselLogTable', 'Vessel History Log')"><i class="fas fa-file-pdf"></i> PDF</button>
                    </div>
                </div>
                <div class="log-filter-btns">
                    <button class="btn-filter active" id="vessel-all-btn" onclick="filterLogByType('vesselLogTable', 'ALL', this)">All</button>
                    <button class="btn-filter" onclick="filterLogByType('vesselLogTable', 'IN', this)">Stock In</button>
                    <button class="btn-filter" onclick="filterLogByType('vesselLogTable', 'OUT', this)">Stock Out</button>
                </div>
                <table id="vesselLogTable"><thead><tr><th>Time</th><th>Item</th><th>Qty</th><th>Type</th><th>Challan</th><th>User</th></tr></thead><tbody></tbody></table>
            </div>

            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>Accessories History</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" class="search-box" placeholder="Search history..." onkeyup="filterLogBySearch('accLogTable', this.value)">
                        <button class="btn btn-success" onclick="downloadPDF('accLogTable', 'Accessories History Log')"><i class="fas fa-file-pdf"></i> PDF</button>
                    </div>
                </div>
                <div class="log-filter-btns">
                    <button class="btn-filter active" id="acc-all-btn" onclick="filterLogByType('accLogTable', 'ALL', this)">All</button>
                    <button class="btn-filter" onclick="filterLogByType('accLogTable', 'IN', this)">Stock In</button>
                    <button class="btn-filter" onclick="filterLogByType('accLogTable', 'OUT', this)">Stock Out</button>
                </div>
                <table id="accLogTable"><thead><tr><th>Time</th><th>Item</th><th>Qty</th><th>Type</th><th>Challan</th><th>User</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="settings" class="tab-page">
            <div id="settings-locked" class="card" style="text-align:center;"><h3><i class="fas fa-lock"></i> Please Login</h3></div>
            <div id="settings-container" style="display:none;" class="card">
                <h3>Change Account PIN</h3>
                <p>User: <span id="setting-user-name" style="color: var(--primary); font-weight: 700;"></span></p>
                <input type="password" id="currPin" placeholder="Current PIN">
                <input type="password" id="newPin" placeholder="New PIN">
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="changeUserPin()">Update PIN Online</button>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCv_lbDM4K5C79TB-P4EOIWVUgi9qHfNaE",
        authDomain: "waterbirdserp.firebaseapp.com",
        databaseURL: "https://waterbirdserp-default-rtdb.firebaseio.com",
        projectId: "waterbirdserp",
        storageBucket: "waterbirdserp.firebasestorage.app",
        messagingSenderId: "799606239136",
        appId: "1:799606239136:web:a07cb470d45f240817fec5"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let USERS_LIST = { "Sazzad Hossain": "866199", "Rokibul Islam": "1122", "Mobin Bin Mihad": "1122", "Md.alamin": "1122", "Md.shipon":"1122" };
    let loggedInUser = null;
    let outCart = [];

    database.ref('users').on('value', snap => {
        const cloudUsers = snap.val();
        if(cloudUsers) { Object.keys(cloudUsers).forEach(u => { USERS_LIST[u.replace(/_/g, ' ')] = cloudUsers[u]; }); }
    });

    function showTab(id) {
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const nav = document.querySelector(`.nav-item[onclick*="${id}"]`);
        if(nav) nav.classList.add('active');
    }

    function toggleEntrySelect() {
        const cat = document.getElementById('entryCategory').value;
        document.getElementById('vesselList').style.display = cat === 'VESSEL' ? 'block' : 'none';
        document.getElementById('accList').style.display = cat === 'ACC' ? 'block' : 'none';
    }

    function addToCart() {
        const cat = document.getElementById('entryCategory').value;
        const name = document.getElementById(cat === 'VESSEL' ? 'vesselList' : 'accList').value;
        const qty = parseInt(document.getElementById('entryQty').value);
        if(!name || isNaN(qty) || qty <= 0) return alert("Please enter valid quantity!");
        outCart.push({ name, qty, category: cat });
        renderCart();
        document.getElementById('entryQty').value = '';
    }

    function renderCart() {
        const container = document.getElementById('cartItems');
        if(outCart.length === 0) {
            container.innerHTML = `<p style="color: var(--text-dim); font-size: 13px; text-align: center;">No items added yet</p>`;
            return;
        }
        container.innerHTML = outCart.map((item, index) => `
            <div class="cart-item-row">
                <div style="font-size:12px;"><strong>${item.name}</strong><br><span style="color:var(--danger)">Qty: ${item.qty}</span></div>
                <button class="btn-mini btn-danger" onclick="removeFromCart(${index})"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
    }

    function removeFromCart(index) { outCart.splice(index, 1); renderCart(); }

    function directIn() {
        const cat = document.getElementById('entryCategory').value;
        const name = document.getElementById(cat === 'VESSEL' ? 'vesselList' : 'accList').value;
        const qty = parseInt(document.getElementById('entryQty').value);
        if(!name || isNaN(qty) || qty <= 0) return alert("Valid data please!");
        const requestData = { name, qty, type: 'IN', category: cat, user: loggedInUser, time: new Date().toLocaleString(), challan: "Inward" };
        processRequest(requestData);
        document.getElementById('entryQty').value = '';
    }

    function submitBulkOut() {
        const challan = document.getElementById('bulkChallan').value;
        if(outCart.length === 0) return alert("List is empty!");
        if(!challan) return alert("Please enter a Challan Number!");
        if(!confirm(`Submit ${outCart.length} items with Challan: ${challan}?`)) return;
        outCart.forEach(item => {
            const requestData = { ...item, type: 'OUT', user: loggedInUser, time: new Date().toLocaleString(), challan: challan };
            processRequest(requestData);
        });
        outCart = []; renderCart(); document.getElementById('bulkChallan').value = '';
        alert("✅ All items sent for processing/approval!");
    }

    function processRequest(data) {
        if(loggedInUser === "Sazzad Hossain") executeFinalUpdate(data, null);
        else database.ref('pending_requests').push(data);
    }

    function executeFinalUpdate(data, pendingKey) {
        const path = data.category === 'VESSEL' ? 'vessels/' : 'accessories/';
        const sanitizedName = data.name.replace(/\s+/g, '_').replace(/\./g, '-');
        const dbRef = database.ref('inventory/' + path + sanitizedName);
        dbRef.transaction(curr => (data.type === 'IN' ? (curr || 0) + data.qty : (curr || 0) - data.qty), (err, commit) => {
            if(commit) {
                database.ref('logs').push(data);
                if(pendingKey) database.ref('pending_requests/' + pendingKey).remove();
            }
        });
    }

    function loginProfile() {
        const name = document.getElementById('userSelect').value;
        const pin = document.getElementById('userPin').value;
        if (USERS_LIST[name] === pin) {
            loggedInUser = name;
            document.getElementById('display-name').innerText = name;
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('entry-container').style.display = 'grid';
            document.getElementById('entry-locked').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'block';
            document.getElementById('settings-locked').style.display = 'none';
            document.getElementById('settings-container').style.display = 'block';
            document.getElementById('setting-user-name').innerText = name;
            if(name === "Sazzad Hossain") {
                document.getElementById('admin-controls').style.display = 'block';
                document.getElementById('nav-pending').style.display = 'flex';
            }
            showTab('dashboard');
        } else alert("Wrong PIN!");
    }

    function logoutProfile() { location.reload(); }

    database.ref('inventory').on('value', snap => {
        const data = snap.val() || {};
        const vBody = document.querySelector('#vesselTable tbody');
        const aBody = document.querySelector('#accTable tbody');
        vBody.innerHTML = ''; aBody.innerHTML = '';
        let count = 0;
        const addRow = (body, k, v) => body.innerHTML += `<tr><td>${k.replace(/_/g,' ')}</td><td>${v}</td></tr>`;
        if(data.vessels) Object.keys(data.vessels).forEach(k => { addRow(vBody, k, data.vessels[k]); count++; });
        if(data.accessories) Object.keys(data.accessories).forEach(k => { addRow(aBody, k, data.accessories[k]); count++; });
        document.getElementById('stat-total-items').innerText = count;
    });

    database.ref('logs').on('value', snap => {
        const logs = snap.val() || {};
        const vLog = document.querySelector('#vesselLogTable tbody');
        const aLog = document.querySelector('#accLogTable tbody');
        vLog.innerHTML = ''; aLog.innerHTML = '';
        let tIn = 0, tOut = 0;
        Object.keys(logs).reverse().forEach(key => {
            const l = logs[key];
            const typeCol = l.type === 'IN' ? '#34d399' : '#fb7185';
            const row = `<tr data-type="${l.type}"><td>${l.time}</td><td>${l.name}</td><td>${l.qty}</td><td style="color:${typeCol}; font-weight:700;">${l.type}</td><td><span class="challan-badge">${l.challan}</span></td><td>${l.user}</td></tr>`;
            if(l.category === 'VESSEL') vLog.innerHTML += row; else aLog.innerHTML += row;
            if(l.type === 'IN') tIn += l.qty; else tOut += l.qty;
        });
        document.getElementById('stat-total-in').innerText = tIn;
        document.getElementById('stat-total-out').innerText = tOut;
    });

    database.ref('pending_requests').on('value', snap => {
        const list = snap.val() || {};
        const tbody = document.querySelector('#pendingTable tbody');
        tbody.innerHTML = '';
        const keys = Object.keys(list);
        document.getElementById('pending-count-badge').innerText = keys.length;
        keys.forEach(k => {
            const l = list[k];
            tbody.innerHTML += `<tr><td>${l.time}</td><td>${l.user}</td><td>${l.name}</td><td>${l.qty}</td><td style="color:${l.type === 'IN' ? '#34d399' : '#fb7185'}; font-weight:700;">${l.type}</td><td><span class="challan-badge">${l.challan}</span></td><td><button class="btn-mini btn-success" onclick='executeFinalUpdate(${JSON.stringify(l)}, "${k}")'>Approve</button></td></tr>`;
        });
    });

    // Combined Filters for History
    function filterLogByType(tableID, type, btn) {
        const parent = btn.parentElement;
        parent.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyLogFilters(tableID);
    }

    function filterLogBySearch(tableID, val) {
        applyLogFilters(tableID);
    }

    function applyLogFilters(tableID) {
        const table = document.getElementById(tableID);
        const searchVal = table.parentElement.querySelector('.search-box').value.toLowerCase();
        const activeTypeBtn = table.parentElement.querySelector('.btn-filter.active').innerText;
        const filterType = activeTypeBtn === 'Stock In' ? 'IN' : (activeTypeBtn === 'Stock Out' ? 'OUT' : 'ALL');
        const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

        for (let row of rows) {
            const text = row.innerText.toLowerCase();
            const rowType = row.getAttribute('data-type');
            const matchesSearch = text.includes(searchVal);
            const matchesType = (filterType === 'ALL' || rowType === filterType);
            row.style.display = (matchesSearch && matchesType) ? "" : "none";
        }
    }

    function filterTable(id, col, val) {
        const rows = document.getElementById(id).getElementsByTagName("tr");
        for (let i = 1; i < rows.length; i++) { rows[i].style.display = rows[i].cells[col].innerText.toLowerCase().includes(val.toLowerCase()) ? "" : "none"; }
    }

    function downloadExcel(tableID) {
        const table = document.getElementById(tableID);
        const wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
        XLSX.writeFile(wb, tableID + ".xlsx");
    }

    function downloadPDF(tableID, title) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18); doc.text("WATER BIRDS LIMITED", 14, 20);
        doc.setFontSize(12); doc.text(title, 14, 30);
        doc.text("Generated on: " + new Date().toLocaleString(), 14, 38);
        doc.autoTable({ html: '#' + tableID, startY: 45, theme: 'grid', headStyles: { fillColor: [129, 140, 248] }, styles: { fontSize: 8 } });
        doc.save(title + ".pdf");
    }

    function changeUserPin() {
        const curr = document.getElementById('currPin').value;
        const newP = document.getElementById('newPin').value;
        if(USERS_LIST[loggedInUser] !== curr) return alert("Current PIN is wrong!");
        if(newP.length < 4) return alert("New PIN too short!");
        database.ref('users/' + loggedInUser.replace(/\s+/g, '_')).set(newP).then(() => { alert("PIN updated successfully online!"); location.reload(); });
    }

    function resetAllData() {
        if(confirm("DANGER: Clear all data forever?")) { database.ref('/').remove(); location.reload(); }
    }
</script>
</body>
</html>
