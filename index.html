<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WATER BIRDS LIMITED</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { 
            --bg-color: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --danger: #f43f5e;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-color); 
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0, transparent 50%),
                radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.05) 0, transparent 50%);
            color: var(--text-main);
            margin: 0; display: flex; height: 100vh; overflow: hidden; 
        }
        
        .sidebar { width: 260px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 40px 25px; }
        .logo-box { padding: 20px; border-radius: 20px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), transparent); border: 1px solid var(--glass-border); text-align: center; }
        .logo-text { font-size: 20px; font-weight: 800; letter-spacing: 1px; background: linear-gradient(to bottom right, #fff, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sidebar-menu { flex: 1; padding: 10px 15px; }
        .nav-item { padding: 14px 18px; border-radius: 14px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.3s; color: var(--text-dim); font-weight: 500; margin-bottom: 5px; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 8px 20px var(--primary-glow); }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 80px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; border-bottom: 1px solid var(--glass-border); }
        .content-area { padding: 30px; overflow-y: auto; flex: 1; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 25px; border-radius: 24px; display: flex; align-items: center; gap: 20px; border: 1px solid var(--glass-border); backdrop-filter: blur(10px); transition: transform 0.3s ease; }
        .card { background: var(--card-bg); border-radius: 24px; padding: 30px; border: 1px solid var(--glass-border); margin-bottom: 25px; backdrop-filter: blur(10px); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); }
        .btn { border: none; padding: 12px 24px; border-radius: 14px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 10px; transition: 0.3s; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px var(--primary-glow); }
        .btn-outline-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { text-align: left; padding: 15px; color: var(--text-dim); font-size: 12px; text-transform: uppercase; letter-spacing: 1.5px; }
        td { padding: 16px 15px; background: rgba(255,255,255,0.02); color: var(--text-main); font-size: 14px; }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid var(--glass-border); border-radius: 14px; outline: none; background: rgba(0,0,0,0.2); color: white; transition: 0.3s; }
        .tab-page { display: none; animation: slideUp 0.4s ease-out; }
        .tab-page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .user-tag { background: var(--card-bg); padding: 10px 20px; border-radius: 15px; border: 1px solid var(--glass-border); font-weight: 600; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <div class="logo-box">
            <div class="logo-text">WATER BIRDS<br>LIMITED</div>
        </div>
        <p style="color: var(--text-dim); font-size: 10px; text-align: center; margin-top: 15px; letter-spacing: 2px; font-weight: 700;">Stock ERP SYSTEM. ONLINE Add document </p>
    </div>
    <div class="sidebar-menu">
        <div class="nav-item active" onclick="showTab('dashboard')"><i class="fas fa-th-large"></i> Dashboard</div>
        <div class="nav-item" onclick="showTab('entry')"><i class="fas fa-edit"></i> Stock Entry</div>
        <div class="nav-item" onclick="showTab('inventory')"><i class="fas fa-boxes"></i> Inventory</div>
        <div class="nav-item" onclick="showTab('logs')"><i class="fas fa-history"></i> Transaction Log</div>
        <div class="nav-item" id="nav-settings" style="display:none;" onclick="showTab('settings')"><i class="fas fa-key"></i> Change PIN</div>
    </div>
    <div style="padding: 20px;">
        <button id="logout-btn" class="btn btn-outline-danger" style="width: 100%; display: none;" onclick="logoutProfile()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
</div>

<div class="main">
    <div class="top-bar">
        <div class="user-tag"><i class="fas fa-user-circle" style="color:var(--primary)"></i> <span id="display-name">Guest User</span></div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div style="width: 10px; height: 10px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success);"></div>
            <span style="font-size: 12px; color: var(--success); font-weight: 700;">SYSTEM ONLINE</span>
        </div>
    </div>

    <div class="content-area">
        <div id="dashboard" class="tab-page active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;"><i class="fas fa-cube"></i></div>
                    <div><p style="margin:0; font-size: 12px; color: var(--text-dim);">Total Items</p><h2 id="stat-total-items" style="margin:0; font-weight: 800;">0</h2></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;"><i class="fas fa-arrow-down"></i></div>
                    <div><p style="margin:0; font-size: 12px; color: var(--text-dim);">Total In</p><h2 id="stat-total-in" style="margin:0; font-weight: 800;">0</h2></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(244, 63, 94, 0.1); color: #f43f5e;"><i class="fas fa-arrow-up"></i></div>
                    <div><p style="margin:0; font-size: 12px; color: var(--text-dim);">Total Out</p><h2 id="stat-total-out" style="margin:0; font-weight: 800;">0</h2></div>
                </div>
            </div>

            <div id="admin-controls" class="card" style="display:none; border: 1px dashed var(--danger);">
                <h3 style="color: var(--danger); margin-top: 0;"><i class="fas fa-user-shield"></i> Master Admin Control</h3>
                <button class="btn btn-danger" onclick="resetAllData()"><i class="fas fa-trash-alt"></i> Reset Database</button>
            </div>

            <div id="login-section" class="card" style="max-width: 400px; margin: 40px auto; text-align: center;">
                <div style="font-size: 40px; color: var(--primary); margin-bottom: 20px;"><i class="fas fa-lock"></i></div>
                <h2>System Login</h2>
                <select id="userSelect">
                    <option value="">Select User</option>
                    <option value="Sazzad Hossain">Sazzad Hossain</option>
                    <option value="Rokibul Islam">Rokibul Islam</option>
                    <option value="Mobin Bin Mihad">Mobin Bin Mihad</option>
                </select>
                <input type="password" id="userPin" placeholder="Enter PIN">
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px; justify-content: center;" onclick="loginProfile()">Login Now</button>
            </div>
        </div>

        <div id="entry" class="tab-page">
            <div id="entry-form" style="display:none; max-width: 500px; margin: 0 auto;" class="card">
                <h3>New Transaction</h3>
                <select id="pName">
                    <option value="12×52 pressure vessel">12×52 pressure vessel</option>
                    <option value="16×65 pressure vessel">16×65 pressure vessel</option>
                    <option value="10×35 pressure vessel">10×35 pressure vessel</option>
                </select>
                <input type="number" id="pQty" placeholder="Enter quantity">
                <div style="display:flex; gap:15px; margin-top: 20px;">
                    <button class="btn btn-primary" style="flex:1; background: var(--success);" onclick="processStock('IN')">STOCK IN</button>
                    <button class="btn btn-danger" style="flex:1;" onclick="processStock('OUT')">STOCK OUT</button>
                </div>
            </div>
            <div id="entry-locked" class="card" style="text-align:center; padding: 50px;">
                <p>Access Locked. Please login from the Dashboard.</p>
            </div>
        </div>

        <div id="inventory" class="tab-page">
            <div class="card">
                <div class="card-header">
                    <h3>Inventory Report</h3>
                </div>
                <table id="stockTable">
                    <thead><tr><th>Product Description</th><th>Current Balance</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="logs" class="tab-page">
            <div class="card"><h3>Stock IN Log</h3><table id="logTableIN"><thead><tr><th>Time</th><th>Product</th><th>QTY</th><th>User</th></tr></thead><tbody></tbody></table></div>
            <div class="card"><h3>Stock OUT Log</h3><table id="logTableOUT"><thead><tr><th>Time</th><th>Product</th><th>QTY</th><th>User</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="settings" class="tab-page">
            <div class="card" style="max-width: 450px; margin: 0 auto;">
                <h3>Change Account PIN</h3>
                <input type="password" id="oldPin" placeholder="Current PIN">
                <input type="password" id="newPin1" placeholder="New PIN">
                <input type="password" id="newPin2" placeholder="Confirm New PIN">
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px; justify-content: center;" onclick="changeUserPin()">Update PIN Now</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG (Stay Untouched) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCv_lbDM4K5C79TB-P4EOIWVUgi9qHfNaE",
        authDomain: "waterbirdserp.firebaseapp.com",
        databaseURL: "https://waterbirdserp-default-rtdb.firebaseio.com",
        projectId: "waterbirdserp",
        storageBucket: "waterbirdserp.firebasestorage.app",
        messagingSenderId: "799606239136",
        appId: "1:799606239136:web:a07cb470d45f240817fec5",
        measurementId: "G-V8PQ77FXYM"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Default User PINs
    let USERS_LIST = { "Sazzad Hossain": "866199", "Rokibul Islam": "1122","Mobin Bin Mihad": "1122" };
    const MASTER_RESET_KEY = "866199"; 
    let loggedInUser = null;

    // --- Critical: PIN SYNC FROM DATABASE ---
    function syncPins() {
        database.ref('user_settings').on('value', snap => {
            const cloudData = snap.val();
            if (cloudData) {
                for (let userKey in cloudData) {
                    // Convert back from "User_Name" to "User Name"
                    const originalName = userKey.replace(/_/g, ' ');
                    if (USERS_LIST[originalName] !== undefined) {
                        USERS_LIST[originalName] = cloudData[userKey].pin;
                    }
                }
            }
        });
    }
    syncPins();

    function showTab(tabId) {
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const items = document.querySelectorAll('.nav-item');
        items.forEach(item => { if(item.innerText.trim() === tabId || (tabId==='settings' && item.innerText.includes('PIN'))) item.classList.add('active'); });
    }

    function loginProfile() {
        const name = document.getElementById('userSelect').value;
        const pin = document.getElementById('userPin').value;
        // Check current pin from the updated USERS_LIST
        if (name && USERS_LIST[name] === pin) {
            loggedInUser = name;
            updateUI(true);
        } else alert("Invalid PIN!");
    }

    function logoutProfile() { loggedInUser = null; updateUI(false); showTab('dashboard'); }

    function updateUI(isLoggedIn) {
        document.getElementById('display-name').innerText = isLoggedIn ? loggedInUser : "Guest User";
        document.getElementById('login-section').style.display = isLoggedIn ? 'none' : 'block';
        document.getElementById('entry-form').style.display = isLoggedIn ? 'block' : 'none';
        document.getElementById('entry-locked').style.display = isLoggedIn ? 'none' : 'block';
        document.getElementById('logout-btn').style.display = isLoggedIn ? 'block' : 'none';
        document.getElementById('nav-settings').style.display = isLoggedIn ? 'flex' : 'none';
        
        const adminPanel = document.getElementById('admin-controls');
        adminPanel.style.display = (isLoggedIn && loggedInUser === "Sazzad Hossain") ? 'block' : 'none';
        if(isLoggedIn) showTab('dashboard');
    }

    function changeUserPin() {
        const oldP = document.getElementById('oldPin').value;
        const p1 = document.getElementById('newPin1').value;
        const p2 = document.getElementById('newPin2').value;

        if (oldP !== USERS_LIST[loggedInUser]) return alert("Current PIN is incorrect!");
        if (p1.length < 4) return alert("New PIN must be at least 4 digits!");
        if (p1 !== p2) return alert("PINs do not match!");

        const userKey = loggedInUser.replace(/\s+/g, '_');
        
        database.ref('user_settings/' + userKey).set({
            pin: p1,
            time: new Date().toLocaleString()
        }).then(() => {
            // Update local memory immediately
            USERS_LIST[loggedInUser] = p1;
            alert("PIN Updated! Log in again with your new PIN.");
            logoutProfile();
            document.getElementById('oldPin').value = '';
            document.getElementById('newPin1').value = '';
            document.getElementById('newPin2').value = '';
        }).catch(e => alert("Error: " + e.message));
    }

    // --- Inventory & Stock Logic (Rest of your existing code) ---
    function processStock(type) {
        const name = document.getElementById('pName').value;
        const qty = parseInt(document.getElementById('pQty').value);
        if (!name || isNaN(qty) || qty <= 0) return alert("Enter valid quantity");

        const dbPath = name.replace(/\s+/g, '_').replace(/\./g, '-');
        database.ref('inventory/' + dbPath).transaction(current => {
            return (type === 'IN') ? (current || 0) + qty : (current || 0) - qty;
        }, (error, committed) => {
            if (committed) {
                database.ref('logs').push({ name, type, qty, user: loggedInUser, time: new Date().toLocaleString() });
                document.getElementById('pQty').value = '';
            }
        });
    }

    database.ref('inventory').on('value', snap => {
        const data = snap.val() || {};
        const body = document.querySelector('#stockTable tbody');
        let total = 0;
        if(body) {
            body.innerHTML = '';
            for (let p in data) {
                body.innerHTML += `<tr><td>${p.replace(/_/g, ' ')}</td><td><b>${data[p]}</b></td></tr>`;
                total++;
            }
            document.getElementById('stat-total-items').innerText = total;
        }
    });

    database.ref('logs').on('value', snap => {
        const logs = snap.val() || {};
        const bIN = document.querySelector('#logTableIN tbody');
        const bOUT = document.querySelector('#logTableOUT tbody');
        let tIn = 0, tOut = 0;
        if(bIN) bIN.innerHTML = ''; if(bOUT) bOUT.innerHTML = '';
        Object.values(logs).reverse().forEach(l => {
            const row = `<tr><td>${l.time}</td><td>${l.name}</td><td>${l.qty}</td><td>${l.user}</td></tr>`;
            if(l.type === 'IN') { bIN.innerHTML += row; tIn += l.qty; } else { bOUT.innerHTML += row; tOut += l.qty; }
        });
        document.getElementById('stat-total-in').innerText = tIn;
        document.getElementById('stat-total-out').innerText = tOut;
    });
</script>
</body>
</html>
